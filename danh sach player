-- ===== CHỐNG LOAD LẠI =====
getgenv().AUTO_LOADED = getgenv().AUTO_LOADED or false
if getgenv().AUTO_LOADED then return end
getgenv().AUTO_LOADED = true

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local startTime = tick()

-- ===== HIỂN THỊ SỐ PLAYER =====
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PlayerCountGui"
ScreenGui.Parent = game.CoreGui

local TextLabel = Instance.new("TextLabel")
TextLabel.Position = UDim2.new(0, 10, 0, 10)
TextLabel.Size = UDim2.new(0, 150, 0, 30)
TextLabel.BackgroundTransparency = 0.5
TextLabel.BackgroundColor3 = Color3.fromRGB(0,0,0)
TextLabel.TextColor3 = Color3.fromRGB(255,255,255)
TextLabel.TextScaled = true
TextLabel.Text = "Players: 0"
TextLabel.Parent = ScreenGui

-- ===== HÀM LẤY DANH SÁCH SERVER =====
local function GetServerList(placeId)
    local servers = {}
    local url = "https://games.roblox.com/v1/games/"..placeId.."/servers/Public?sortOrder=Asc&limit=100"
    local success, result = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)
    if success and result and result.data then
        servers = result.data
    end
    return servers
end

-- ===== AUTO HOP & UPDATE PLAYER =====
task.spawn(function()
    while true do
        task.wait(1) -- update 1s 1 lần

        -- Cập nhật số player
        local playerCount = #Players:GetPlayers()
        TextLabel.Text = "Players: "..playerCount

        local elapsed = tick() - startTime

        -- Hop ngay nếu > 2 player
        if playerCount > 2 then
            local servers = GetServerList(game.PlaceId)
            if #servers > 0 then
                local target = servers[1]
                TeleportService:TeleportToPlaceInstance(game.PlaceId, target.id, Players.LocalPlayer)
                return -- thoát vòng lặp sau khi hop
            end
        end

        -- Hop sau 50s → server ít người nhất
        if elapsed >= 50 then
            local servers = GetServerList(game.PlaceId)
            if #servers > 0 then
                table.sort(servers, function(a,b) return a.playing < b.playing end)
                TeleportService:TeleportToPlaceInstance(game.PlaceId, servers[1].id, Players.LocalPlayer)
                return
            end
        end
    end
end)
