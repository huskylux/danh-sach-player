-- ===== PLAYER COUNT UI + AUTO HOP (FIXED) =====
repeat task.wait() until game:IsLoaded() and game.Players.LocalPlayer

if getgenv().LOW_SERVER_HOP_LOADED then return end
getgenv().LOW_SERVER_HOP_LOADED = true

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

local PLACE_ID = game.PlaceId
local JOB_ID = game.JobId
local HOP_DELAY = 30

-- ===== UI =====
local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,220,0,90)
frame.Position = UDim2.new(0,20,0.35,0)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,30)
title.BackgroundTransparency = 1
title.Text = "Server Monitor"
title.TextColor3 = Color3.fromRGB(0,255,0)
title.Font = Enum.Font.SourceSansBold
title.TextScaled = true

local info = Instance.new("TextLabel", frame)
info.Position = UDim2.new(0,5,0,35)
info.Size = UDim2.new(1,-10,1,-40)
info.BackgroundTransparency = 1
info.TextColor3 = Color3.fromRGB(255,255,255)
info.TextXAlignment = Left
info.TextYAlignment = Top
info.TextSize = 14
info.Font = Enum.Font.SourceSans

local function updateUI()
    info.Text =
        "Players: "..#Players:GetPlayers().."\n"..
        "Auto hop: ON\n"..
        "Every: "..HOP_DELAY.."s"
end
updateUI()

-- ===== GET LOWEST SERVER (FIXED) =====
local function getLowestServer()
    local lowestServer, lowestCount
    local cursor = ""

    for i = 1, 5 do -- duyệt 5 trang (≈500 server)
        local url =
            "https://games.roblox.com/v1/games/"..PLACE_ID..
            "/servers/Public?sortOrder=Asc&limit=100&cursor="..cursor

        local ok, res = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(url))
        end)

        if not ok or not res or not res.data then break end

        for _, s in ipairs(res.data) do
            if s.id ~= JOB_ID and s.playing < s.maxPlayers then
                if not lowestCount or s.playing < lowestCount then
                    lowestCount = s.playing
                    lowestServer = s.id
                end
            end
        end

        cursor = res.nextPageCursor
        if not cursor then break end
    end

    print("[AUTO HOP] Found server:", lowestServer, "Players:", lowestCount)
    return lowestServer
end

-- ===== AUTO HOP LOOP =====
task.spawn(function()
    while task.wait(HOP_DELAY) do
        local serverId = getLowestServer()
        if serverId then
            TeleportService:TeleportToPlaceInstance(PLACE_ID, serverId, LocalPlayer)
        end
    end
end)
