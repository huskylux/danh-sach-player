--== Services ==--
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local PlaceId = game.PlaceId

--== GUI ==--
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 300, 0, 400)
Frame.Position = UDim2.new(0, 10, 0, 10)
Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
Frame.BorderSizePixel = 0

local PlayerCountLabel = Instance.new("TextLabel", Frame)
PlayerCountLabel.Size = UDim2.new(1, -10, 0, 30)
PlayerCountLabel.Position = UDim2.new(0, 5, 0, 5)
PlayerCountLabel.TextColor3 = Color3.new(1,1,1)
PlayerCountLabel.TextScaled = true
PlayerCountLabel.BackgroundTransparency = 1
PlayerCountLabel.Text = "Players: 0"

local ServerListLabel = Instance.new("TextLabel", Frame)
ServerListLabel.Size = UDim2.new(1, -10, 1, -40)
ServerListLabel.Position = UDim2.new(0, 5, 0, 35)
ServerListLabel.TextColor3 = Color3.new(1,1,1)
ServerListLabel.TextWrapped = true
ServerListLabel.TextYAlignment = Enum.TextYAlignment.Top
ServerListLabel.BackgroundTransparency = 1
ServerListLabel.Text = "Server list:\n"

--== Variables ==--
local ServerData = {}

--== Functions ==--
local function updatePlayerCount()
    PlayerCountLabel.Text = "Players: "..tostring(#Players:GetPlayers())
end

local function getServers(cursor)
    local url = "https://games.roblox.com/v1/games/"..PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
    if cursor then
        url = url.."&cursor="..cursor
    end

    local success, response = pcall(function()
        return game:HttpGet(url)
    end)

    if success then
        local data = HttpService:JSONDecode(response)
        return data
    else
        return nil
    end
end

local function updateServerList()
    local allServers = {}
    local cursor = nil

    repeat
        local data = getServers(cursor)
        if data and data.data then
            for _, server in ipairs(data.data) do
                if server.playing < server.maxPlayers then -- chỉ lấy server còn chỗ
                    table.insert(allServers, {id = server.id, players = server.playing, maxPlayers = server.maxPlayers})
                end
            end
            cursor = data.nextPageCursor
        else
            break
        end
    until not cursor

    table.sort(allServers, function(a,b) return a.players < b.players end)
    ServerData = allServers

    -- Update GUI
    local text = "Server list (least players first):\n"
    for i, s in ipairs(allServers) do
        text = text..i..". ID:"..s.id.." Players:"..s.players.."/"..s.maxPlayers.."\n"
    end
    ServerListLabel.Text = text
end

--== Auto hop server every 50s ==--
spawn(function()
    while true do
        wait(50)
        if #ServerData > 0 then
            for _, s in ipairs(ServerData) do
                if s.players < s.maxPlayers then
                    print("Teleporting to server: "..s.id.." with "..s.players.." players")
                    TeleportService:TeleportToPlaceInstance(PlaceId, s.id, LocalPlayer)
                    break
                end
            end
        end
    end
end)

--== Update GUI and server list every 1s ==--
spawn(function()
    while true do
        updatePlayerCount()
        updateServerList()
        wait(1)
    end
end)
